### 1. 노드 수 결정

Qdrant 클러스터의 노드 수는 **비용·장애 허용성(내구성)·성능** 간의 우선순위에 따라 달라진다.

|우선순위|권장 구성|장점|단점|
|---|---|---|---|
|비용 절감|**단일 노드**|인프라 비용 최소|장애 시 즉시 다운타임 발생, 영구 손실 복구 불가|
|내구성 최우선|**3개 이상 노드 + 2-배수 복제**|노드 1개 장애 시에도 읽기·쓰기·컬렉션 작업 지속, 영구 손실 복구 가능, 로드밸런스로 성능 향상|비용 증가|
|균형형|**2개 노드 + 복제**|노드 1개 장애 시 대부분의 읽기·쓰기 가능, 비용은 3노드보다 저렴|컬렉션 작업(생성·수정·삭제)은 중단, 영구 손실 복구 불가|

요약하면 **단일 노드는 비프로덕션**, **3+ 노드 복제 클러스터가 권장**, **2노드 복제는 비용·성능 절충안**이다.


### 2. 자체 호스팅에서 분산 모드 활성화

1. **환경 변수 또는 설정**
    
    ```yaml
    cluster:
      enabled: true
      p2p:
        port: 6335      # 내부 통신 포트
      consensus:
        tick_period_ms: 100
    ```
    
    혹은 `QDRANT__CLUSTER__ENABLED=true` 지정.
    
2. **첫 번째 노드 기동**
    
    ```bash
    ./qdrant --uri 'http://node1:6335'
    ```
    
3. **추가 노드 합류**
    
    ```bash
    ./qdrant --bootstrap 'http://node1:6335'
    # 필요 시 --uri 로 자신 주소 명시
    ```
    
4. **상태 확인**
    
    ```http
    GET /cluster
    ```
    

> 분산 모드 활성화만으로 데이터가 자동 복제되지 않는다.  
> _Replication 설정_ 또는 _Shard 이동_ 단계가 필요하다.


### 3. Qdrant Cloud에서 분산 모드

- 클러스터 버전을 **v1.7.4 이상**으로 유지하면 안정성이 높다.
    
- Cloud 콘솔의 **Scale Up**으로 노드 수를 2 이상으로 늘리면 분산 모드가 자동 설정된다.
    
- 새 노드는 비어 있으므로 **새 컬렉션 생성** 또는 **샤드 복제/이동**으로 데이터를 분산해야 한다.

### 4. 샤딩 개요

- **Shard**: 포인트를 저장·검색하는 독립 단위
    
- **자동 샤딩**(기본): 일관 해시로 분배
    
- **사용자 정의 샤딩**: `sharding_method: custom` 로 지정, `shard_key` 별로 포인트 업로드
    

#### 샤드 수 선택

- `shard_number`는 **노드 수의 배수**로 설정한다.
    
- 노드당 최소 2샤드를 권장하며, **미래 확장**을 고려해 12샤드 구성이 무난하다.

### 5. 샤드 이동·복제

**샤드 이동**
~~~
POST /collections/{col}/cluster
{
  "move_shard": {
    "shard_id": 0,
    "from_peer_id": 111,
    "to_peer_id": 222,
    "method": "snapshot"   # stream_records | wal_delta
  }
}
~~~

