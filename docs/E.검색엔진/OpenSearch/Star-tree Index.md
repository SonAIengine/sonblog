집계(Aggregation)는 데이터 규모가 커질수록 집계 성능은 급격히 저하되며, 이로 인해 쿼리 지연(latency)과 리소스 소비가 증가하는 문제가 있습니다. 이를 해결하기 위해 OpenSearch 2.18부터 **신규 기능인 Star-tree Index**가 실험적으로 도입되었습니다.

## Star-tree Index란?

**Star-tree Index**는 Apache Pinot에서 영감을 받은 OpenSearch의 첫 번째 **다중 필드 기반 집계 가속 인덱스**입니다.  
인덱싱 시점에 특정 메트릭(metric)에 대해 미리 집계 결과를 계산(Pre-aggregation)해 저장함으로써, 복잡한 집계 쿼리의 실행 속도를 획기적으로 개선합니다.

예를 들어, `HTTP status code`별 평균 요청 크기 또는 요청 수를 집계할 때, 전체 2억 건 중 status=200인 데이터에 대해 평균을 구하는 쿼리는 약 **4.2초**가 소요되지만, **Star-tree를 사용하면 단 6.3ms**로 응답이 가능합니다.

## Star-tree의 동작 방식

Star-tree는 지정된 **차원(Dimensions)** 조합에 따라 **트리 구조**로 구성됩니다.

- 루트부터 리프까지의 경로는 `status`, `day`와 같은 차원 조합을 의미합니다.
    
- 리프 노드는 해당 조건에 매칭되는 문서의 **사전 집계 결과(예: 평균, 합계, 카운트 등)**를 저장합니다.
    
- `*`(스타 노드)는 특정 차원 전체에 대한 집계 결과를 포함해, **쿼리 조건에 따라 브랜치를 건너뛰는 최적화**가 가능합니다.
    

이 구조 덕분에 자주 조회되는 고빈도 조건에 대해서도 빠른 집계가 가능합니다.

## 성능 비교 예시

|쿼리|문서 수|일반 쿼리 지연시간|Star-tree 지연시간|
|---|---|---|---|
|status=200에 대한 평균(duration)|2억 건|4.2초|6.3ms|
|status=400에 대한 평균(duration)|3천 건|5ms|6.5ms|

Star-tree는 고빈도 조건에서도 **지연시간이 일정하게 유지**되며, 저빈도 조건과의 차이가 거의 없습니다.


## 주요 장점

### 1. 예측 가능한 낮은 지연 시간

- 대용량 데이터에서도 평균 지연 시간이 **ms 단위**로 줄어듭니다.
    

### 2. 멀티 집계 지원

- 여러 필드에 대해 집계를 수행할 경우에도, 트리 traversal이 중복되지 않아 빠릅니다.
    

### 3. 복잡한 집계 쿼리 처리량 향상

- `date_histogram + sub aggregation` 조합에서도 기존보다 20배 이상의 처리량 향상
    

| 쿼리                       | 문서 수   | 기존 지연시간 | Star-tree 지연시간 | 기존 처리량 | Star-tree 처리량 |
| ------------------------ | ------ | ------- | -------------- | ------ | ------------- |
| 연도별 tip 합계 (passenger=1) | 1.2억 건 | 13초     | 94ms           | 0.08   | 2.01          |

### 4. 구성 유연성

- `max_leaf_docs` 파라미터를 조정해 **저장 공간 vs 쿼리 속도**를 균형 있게 선택 가능

## 사용 방법

```
PUT /my-index
{
  "mappings": {
    "properties": {
      "status": { "type": "keyword" },
      "day": { "type": "integer" },
      "size": { "type": "float" }
    }
  },
  "settings": {
    "index": {
      "composite_index": {
        "star_tree": {
          "dimensions": ["status", "day"],
          "metrics": ["avg(size)", "count(*)"],
          "max_leaf_docs": 10000
        }
      }
    }
  }
}
```

- 위와 같이 인덱스 생성 시 설정
    
- 쿼리 문법은 기존과 동일하게 사용 가능
    
- OpenSearch 2.19 기준으로 일부 aggregation 타입만 지원
